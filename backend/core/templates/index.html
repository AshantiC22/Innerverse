<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Innerverse | The Living House - Multi-Room</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        font-family: "Courier New", Courier, monospace;
        color: white;
      }

      #canvas-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .gate {
        position: relative;
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        transition: opacity 1s ease-in-out;
        background: radial-gradient(
          circle at center,
          rgba(20, 20, 30, 0.95),
          rgba(0, 0, 0, 0.98)
        );
      }

      .porch-content {
        background: linear-gradient(
          135deg,
          rgba(40, 40, 50, 0.9),
          rgba(20, 20, 30, 0.95)
        );
        padding: 50px 60px;
        border-radius: 20px;
        color: white;
        text-align: center;
        border: 2px solid rgba(100, 100, 120, 0.4);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        max-width: 500px;
      }

      .porch-content h1 {
        margin: 0 0 15px 0;
        font-size: 2.5em;
        letter-spacing: 4px;
        text-transform: uppercase;
        background: linear-gradient(135deg, #ffffff, #a0c0e0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .porch-content p {
        margin: 10px 0 25px 0;
        font-size: 1.1em;
        color: rgba(255, 255, 255, 0.8);
        letter-spacing: 1px;
      }

      textarea {
        width: 100%;
        max-width: 400px;
        height: 120px;
        background: rgba(10, 10, 20, 0.8);
        color: #fff;
        border: 2px solid rgba(100, 100, 120, 0.4);
        padding: 15px;
        margin: 15px 0;
        font-family: inherit;
        font-size: 15px;
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      textarea:focus {
        outline: none;
        border-color: rgba(160, 192, 224, 0.8);
        box-shadow: 0 0 20px rgba(160, 192, 224, 0.2);
      }

      button {
        padding: 15px 35px;
        cursor: pointer;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-weight: bold;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
      }

      button:disabled {
        background: linear-gradient(135deg, #555 0%, #333 100%);
        cursor: not-allowed;
      }

      .room-ui {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 5;
        opacity: 0;
        transition: opacity 2s ease;
        text-align: center;
        background: linear-gradient(
          135deg,
          rgba(20, 20, 30, 0.9),
          rgba(40, 40, 50, 0.85)
        );
        padding: 25px 40px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        color: white;
      }

      #room-status {
        margin: 0 0 5px 0;
        font-size: 1.1em;
        letter-spacing: 2px;
      }

      #current-room-name {
        margin: 5px 0 10px 0;
        font-size: 1.3em;
        color: rgba(160, 192, 224, 0.9);
        letter-spacing: 1px;
        font-weight: bold;
      }

      #intensity-display {
        margin: 5px 0 15px 0;
        font-size: 0.9em;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none !important;
      }

      .transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.6s ease-in-out;
      }

      .transition-overlay.active {
        opacity: 1;
      }

      .rain-overlay,
      .fog-overlay,
      .sunset-glow,
      .heat-wave,
      .love-glow,
      .dark-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 3;
        opacity: 0;
        transition: opacity 1.5s ease;
      }

      .rain-overlay.active,
      .fog-overlay.active,
      .sunset-glow.active,
      .heat-wave.active,
      .love-glow.active,
      .dark-overlay.active {
        opacity: 1;
      }

      .sunset-glow {
        background: radial-gradient(
          ellipse at 50% 40%,
          rgba(255, 180, 100, 0.3),
          transparent 60%
        );
      }

      .fog-overlay {
        background: radial-gradient(
          ellipse at center,
          rgba(200, 200, 220, 0.3),
          transparent
        );
      }

      .heat-wave {
        background: radial-gradient(
          ellipse at center,
          rgba(255, 100, 50, 0.2),
          transparent
        );
      }

      .love-glow {
        background: radial-gradient(
          ellipse at center,
          rgba(255, 150, 200, 0.4),
          transparent 70%
        );
      }

      .dark-overlay {
        background: radial-gradient(
          ellipse at center,
          rgba(0, 0, 0, 0.7),
          rgba(0, 0, 0, 0.9)
        );
      }

      .room-navigation {
        position: fixed;
        top: 30px;
        right: 30px;
        z-index: 5;
        opacity: 0;
        transition: opacity 2s ease;
      }

      .nav-button {
        display: block;
        margin: 8px 0;
        padding: 10px 20px;
        background: rgba(30, 30, 40, 0.8);
        border: 2px solid rgba(100, 100, 120, 0.4);
        color: white;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        letter-spacing: 1px;
      }

      .nav-button:hover {
        background: rgba(50, 50, 60, 0.9);
        border-color: rgba(160, 192, 224, 0.6);
        transform: translateX(-5px);
      }

      .nav-button.current-room {
        background: rgba(102, 126, 234, 0.4);
        border-color: rgba(102, 126, 234, 0.8);
      }

      .error-message {
        color: #ff6b6b;
        font-size: 13px;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="canvas-container"></div>
    <div class="transition-overlay" id="transition-overlay"></div>
    <div class="rain-overlay" id="rain-overlay"></div>
    <div class="fog-overlay" id="fog-overlay"></div>
    <div class="sunset-glow" id="sunset-glow"></div>
    <div class="heat-wave" id="heat-wave"></div>
    <div class="love-glow" id="love-glow"></div>
    <div class="dark-overlay" id="dark-overlay"></div>

    <div id="entrance" class="gate">
      <div class="porch-content">
        <h1>The Living House</h1>
        <p>What brings you here today?</p>
        <textarea
          id="user-input"
          placeholder="Share what's in your heart..."
        ></textarea>
        <div class="error-message" id="error-msg">
          Please share your feelings.
        </div>
        <button id="enter-btn">Cross the Threshold</button>
      </div>
    </div>

    <div id="interior-ui" class="room-ui">
      <h2 id="room-status">Emotions</h2>
      <p id="current-room-name">Hallway</p>
      <p id="intensity-display"></p>
      <button onclick="window.location.reload()">Leave & Return</button>
    </div>

    <div id="room-navigation" class="room-navigation">
      <button class="nav-button current-room" data-room="hallway">
        Hallway
      </button>
      <button class="nav-button" data-room="living">Living Room</button>
      <button class="nav-button" data-room="bedroom">Bedroom</button>
      <button class="nav-button" data-room="study">Study</button>
      <button class="nav-button" data-room="garden">Garden</button>
      <button class="nav-button" data-room="attic">Attic</button>
    </div>

    <script>
      // CORE VARIABLES
      let scene,
        camera,
        renderer,
        clock = new THREE.Clock();
      let currentRoom = "hallway",
        emotionBlend = {},
        currentIntensity = 1.0;
      let hasEntered = false,
        isTransitioning = false;
      let roomObjects = {},
        particles = {};
      let emotionState = {
        targetHeight: 3.5,
        currentHeight: 3.5,
        breathing: 0.05,
        shake: 0,
      };

      // EMOTION KEYWORDS
      const EMOTIONS = {
        HAPPY: {
          pri: ["happy", "joy", "elated"],
          sec: ["good", "great", "wonderful"],
        },
        LOVE: {
          pri: ["love", "affection", "warmth"],
          sec: ["grateful", "thankful"],
        },
        PEACE: {
          pri: ["peace", "calm", "serene"],
          sec: ["quiet", "still", "centered"],
        },
        HOPE: {
          pri: ["hope", "optimistic", "bright"],
          sec: ["better", "improve", "future"],
        },
        ANXIETY: {
          pri: ["anxious", "nervous", "worried", "panic"],
          sec: ["tense", "uneasy"],
        },
        FEAR: {
          pri: ["fear", "afraid", "scared", "terrified"],
          sec: ["nightmare", "horror"],
        },
        ANGER: {
          pri: ["angry", "furious", "rage"],
          sec: ["annoyed", "frustrated"],
        },
        SADNESS: {
          pri: ["sad", "cry", "depressed", "down"],
          sec: ["unhappy", "gloomy"],
        },
        GRIEF: {
          pri: ["grief", "heartbreak", "devastated"],
          sec: ["loss", "mourning", "empty"],
        },
        LONELINESS: {
          pri: ["lonely", "alone", "isolated"],
          sec: ["nobody", "friendless"],
        },
        NOSTALGIA: {
          pri: ["nostalgic", "remember", "memory", "past"],
          sec: ["reminisce", "before"],
        },
        CONTEMPLATION: {
          pri: ["thinking", "ponder", "reflect"],
          sec: ["question", "deep", "meaning"],
        },
      };

      const INTENSITY = {
        EXTREME: ["very", "extremely", "incredibly", "completely"],
        HIGH: ["really", "quite", "pretty", "fairly"],
        MILD: ["a little", "a bit", "somewhat", "slightly"],
      };

      // ROOM DEFINITIONS
      const ROOMS = {
        hallway: {
          name: "Central Hallway",
          emotions: [],
          camera: { x: 0, y: 1.6, z: 6 },
          look: { x: 0, y: 1.5, z: 0 },
          bg: 0x2a2a3a,
        },
        living: {
          name: "Living Room",
          emotions: ["HAPPY", "LOVE", "ANGER", "SADNESS"],
          camera: { x: 0, y: 1.6, z: 4 },
          look: { x: 0, y: 1.5, z: -3 },
          bg: 0x2a2a3a,
        },
        bedroom: {
          name: "Bedroom of Memories",
          emotions: ["NOSTALGIA", "GRIEF", "LONELINESS"],
          camera: { x: 0, y: 1.6, z: 5 },
          look: { x: 0, y: 1.2, z: -2 },
          bg: 0x1a1a2a,
        },
        study: {
          name: "Study",
          emotions: ["CONTEMPLATION", "ANXIETY"],
          camera: { x: -2, y: 1.6, z: 4 },
          look: { x: 0, y: 1.5, z: -2 },
          bg: 0x2a3a4a,
        },
        garden: {
          name: "Inner Garden",
          emotions: ["HOPE", "PEACE", "LOVE"],
          camera: { x: 0, y: 1.8, z: 6 },
          look: { x: 0, y: 1.0, z: 0 },
          bg: 0x3a4a3a,
        },
        attic: {
          name: "Attic of Shadows",
          emotions: ["FEAR", "ANXIETY"],
          camera: { x: 0, y: 1.4, z: 5 },
          look: { x: 0, y: 1.8, z: -2 },
          bg: 0x0a0a1a,
        },
      };

      // INITIALIZATION
      function init3D() {
        scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x1a1a2e, 8, 20);

        camera = new THREE.PerspectiveCamera(
          70,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(0, 1.6, 8);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.setClearColor(0x0a0a0a);
        document
          .getElementById("canvas-container")
          .appendChild(renderer.domElement);

        createParticles();
        buildAllRooms();
        setRoomVisibility("hallway", true);

        document
          .getElementById("enter-btn")
          .addEventListener("click", enterHouse);
        document.querySelectorAll(".nav-button").forEach((btn) => {
          btn.addEventListener("click", function () {
            navigateToRoom(this.dataset.room);
          });
        });

        window.addEventListener("resize", onWindowResize);
        animate();
      }

      // CREATE PARTICLE SYSTEMS
      function createParticles() {
        const makeParticles = (count, color, size) => {
          const geo = new THREE.BufferGeometry();
          const pos = new Float32Array(count * 3);
          for (let i = 0; i < count * 3; i += 3) {
            pos[i] = (Math.random() - 0.5) * 20;
            pos[i + 1] = Math.random() * 10;
            pos[i + 2] = (Math.random() - 0.5) * 20;
          }
          geo.setAttribute("position", new THREE.BufferAttribute(pos, 3));
          return new THREE.Points(
            geo,
            new THREE.PointsMaterial({
              color,
              size,
              transparent: true,
              opacity: 0,
              blending:
                color === 0xffaaff
                  ? THREE.AdditiveBlending
                  : THREE.NormalBlending,
            })
          );
        };

        particles.rain = makeParticles(800, 0x6a9ccc, 0.08);
        particles.mist = makeParticles(300, 0xcccccc, 0.4);
        particles.sparkle = makeParticles(200, 0xffaaff, 0.12);
        particles.dust = makeParticles(150, 0xf0e68c, 0.05);

        Object.values(particles).forEach((p) => scene.add(p));
      }

      // BUILD ALL ROOMS
      function buildAllRooms() {
        Object.keys(ROOMS).forEach((roomId) => {
          const grp = new THREE.Group();
          grp.visible = false;

          const ambient = new THREE.AmbientLight(0xffffff, 0.3);
          grp.add(ambient);

          const mainLight = new THREE.PointLight(0xffffcc, 1.2, 18);
          mainLight.position.set(0, 3, 0);
          grp.add(mainLight);

          // Floor
          const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(12, 12),
            new THREE.MeshStandardMaterial({
              color: getFloorColor(roomId),
              roughness: 0.8,
            })
          );
          floor.rotation.x = -Math.PI / 2;
          grp.add(floor);

          // Walls
          const wallColor = getWallColor(roomId);
          const wallMat = new THREE.MeshStandardMaterial({
            color: wallColor,
            roughness: 0.9,
          });

          const backWall = new THREE.Mesh(
            new THREE.BoxGeometry(12, 3.5, 0.3),
            wallMat.clone()
          );
          backWall.position.set(0, 1.75, -6);
          grp.add(backWall);

          const leftWall = new THREE.Mesh(
            new THREE.BoxGeometry(0.3, 3.5, 12),
            wallMat.clone()
          );
          leftWall.position.set(-6, 1.75, 0);
          grp.add(leftWall);

          const rightWall = new THREE.Mesh(
            new THREE.BoxGeometry(0.3, 3.5, 12),
            wallMat.clone()
          );
          rightWall.position.set(6, 1.75, 0);
          grp.add(rightWall);

          // Ceiling
          const ceiling = new THREE.Mesh(
            new THREE.PlaneGeometry(12, 12),
            new THREE.MeshStandardMaterial({ color: getCeilingColor(roomId) })
          );
          ceiling.rotation.x = Math.PI / 2;
          ceiling.position.y = 3.5;
          grp.add(ceiling);

          // Room-specific furniture
          addRoomFurniture(grp, roomId);

          roomObjects[roomId] = grp;
          scene.add(grp);
        });
      }

      // HELPER: Get room colors
      function getFloorColor(roomId) {
        const colors = {
          hallway: 0x8a7a6a,
          living: 0x5a4a3a,
          bedroom: 0x4a3a4a,
          study: 0x3a4a5a,
          garden: 0x4a5a3a,
          attic: 0x2a2a2a,
        };
        return colors[roomId] || 0x5a4a3a;
      }

      function getWallColor(roomId) {
        const colors = {
          hallway: 0xb8a898,
          living: 0x8b7355,
          bedroom: 0x6a5a6a,
          study: 0x5a6a7a,
          garden: 0x7a8a6a,
          attic: 0x3a3a3a,
        };
        return colors[roomId] || 0x8b7355;
      }

      function getCeilingColor(roomId) {
        const colors = {
          hallway: 0xa09888,
          living: 0x6a5a4a,
          bedroom: 0x5a4a5a,
          study: 0x4a5a6a,
          garden: 0x6a7a5a,
          attic: 0x2a2a2a,
        };
        return colors[roomId] || 0x6a5a4a;
      }

      // ADD ROOM-SPECIFIC FURNITURE
      function addRoomFurniture(grp, roomId) {
        if (roomId === "living") {
          // Fireplace
          const fireplace = new THREE.Mesh(
            new THREE.BoxGeometry(2.5, 2, 0.6),
            new THREE.MeshStandardMaterial({ color: 0x3a2a2a })
          );
          fireplace.position.set(0, 1, -5.7);
          grp.add(fireplace);

          const fireplaceLight = new THREE.PointLight(0xff6600, 1.5, 8);
          fireplaceLight.position.set(0, 1, -5.5);
          grp.add(fireplaceLight);

          // Couch
          const couch = new THREE.Mesh(
            new THREE.BoxGeometry(3.5, 0.7, 1.4),
            new THREE.MeshStandardMaterial({ color: 0x8b4513 })
          );
          couch.position.set(-4, 0.35, -2.5);
          grp.add(couch);
        } else if (roomId === "bedroom") {
          // Bed
          const bed = new THREE.Mesh(
            new THREE.BoxGeometry(2.5, 0.5, 3.5),
            new THREE.MeshStandardMaterial({ color: 0x6a5a7a })
          );
          bed.position.set(-3, 0.25, -3);
          grp.add(bed);
        } else if (roomId === "study") {
          // Desk
          const desk = new THREE.Mesh(
            new THREE.BoxGeometry(2, 0.1, 1),
            new THREE.MeshStandardMaterial({ color: 0x4a3a2a })
          );
          desk.position.set(0, 0.8, -4);
          grp.add(desk);

          // Bookshelf
          const bookshelf = new THREE.Mesh(
            new THREE.BoxGeometry(1.5, 2.5, 0.4),
            new THREE.MeshStandardMaterial({ color: 0x3a2a1a })
          );
          bookshelf.position.set(5, 1.25, -3);
          grp.add(bookshelf);
        } else if (roomId === "garden") {
          // Plants
          for (let i = 0; i < 5; i++) {
            const plant = new THREE.Mesh(
              new THREE.ConeGeometry(0.2, 0.6, 8),
              new THREE.MeshStandardMaterial({ color: 0x2d5016 })
            );
            plant.position.set(
              (Math.random() - 0.5) * 8,
              0.3,
              (Math.random() - 0.5) * 8
            );
            grp.add(plant);
          }
        } else if (roomId === "attic") {
          // Boxes
          for (let i = 0; i < 4; i++) {
            const box = new THREE.Mesh(
              new THREE.BoxGeometry(0.6, 0.6, 0.6),
              new THREE.MeshStandardMaterial({ color: 0x4a3a2a })
            );
            box.position.set(
              (Math.random() - 0.5) * 6,
              0.3,
              (Math.random() - 0.5) * 6
            );
            grp.add(box);
          }
        }
      }

      // ROOM VISIBILITY
      function setRoomVisibility(roomId, visible) {
        Object.keys(roomObjects).forEach((id) => {
          roomObjects[id].visible = id === roomId;
        });
        currentRoom = roomId;
        renderer.setClearColor(ROOMS[roomId].bg);
        document.getElementById("current-room-name").textContent =
          ROOMS[roomId].name;

        document.querySelectorAll(".nav-button").forEach((btn) => {
          btn.classList.toggle("current-room", btn.dataset.room === roomId);
        });
      }

      // EMOTION ANALYSIS
      function analyzeEmotion(text) {
        text = text.toLowerCase();
        let emotions = {};
        let intensity = 1.0;

        // Detect intensity
        for (let level in INTENSITY) {
          for (let keyword of INTENSITY[level]) {
            if (text.includes(keyword)) {
              intensity =
                level === "EXTREME" ? 2.0 : level === "HIGH" ? 1.5 : 0.5;
              break;
            }
          }
        }

        // Detect emotions
        for (let emotion in EMOTIONS) {
          let score = 0;
          for (let kw of EMOTIONS[emotion].pri) {
            if (text.includes(kw)) score += 2;
          }
          for (let kw of EMOTIONS[emotion].sec) {
            if (text.includes(kw)) score += 1;
          }
          if (score > 0) emotions[emotion] = score;
        }

        // Normalize
        let total = Object.values(emotions).reduce((a, b) => a + b, 0);
        if (total > 0) {
          for (let key in emotions) emotions[key] /= total;
        } else {
          emotions = { PEACE: 1.0 };
        }

        return { emotions, intensity };
      }

      // ENTER HOUSE
      async function enterHouse() {
        const text = document.getElementById("user-input").value.trim();
        if (!text) {
          document.getElementById("error-msg").style.display = "block";
          return;
        }

        const analysis = analyzeEmotion(text);
        emotionBlend = analysis.emotions;
        currentIntensity = analysis.intensity;

        hasEntered = true;
        updateHouseAtmosphere();

        document.getElementById("entrance").style.opacity = "0";
        setTimeout(() => {
          document.getElementById("entrance").classList.add("hidden");
          document.getElementById("interior-ui").style.opacity = "1";
          document.getElementById("room-navigation").style.opacity = "1";
          moveCamera(ROOMS.hallway.camera, ROOMS.hallway.look, 2000);
        }, 1000);
      }

      // NAVIGATE TO ROOM
      function navigateToRoom(roomId) {
        if (isTransitioning || roomId === currentRoom) return;
        isTransitioning = true;

        const overlay = document.getElementById("transition-overlay");
        overlay.classList.add("active");

        setTimeout(() => {
          setRoomVisibility(roomId, true);
          moveCamera(ROOMS[roomId].camera, ROOMS[roomId].look, 1000);
          updateHouseAtmosphere();

          setTimeout(() => {
            overlay.classList.remove("active");
            isTransitioning = false;
          }, 600);
        }, 600);
      }

      // MOVE CAMERA
      function moveCamera(target, lookAt, duration) {
        const start = {
          x: camera.position.x,
          y: camera.position.y,
          z: camera.position.z,
        };
        const startTime = Date.now();

        function update() {
          const progress = Math.min((Date.now() - startTime) / duration, 1);
          const eased =
            progress < 0.5
              ? 2 * progress * progress
              : 1 - Math.pow(-2 * progress + 2, 2) / 2;

          camera.position.x = start.x + (target.x - start.x) * eased;
          camera.position.y = start.y + (target.y - start.y) * eased;
          camera.position.z = start.z + (target.z - start.z) * eased;
          camera.lookAt(lookAt.x, lookAt.y, lookAt.z);

          if (progress < 1) requestAnimationFrame(update);
        }
        update();
      }

      // UPDATE ATMOSPHERE
      function updateHouseAtmosphere() {
        let emotionText = Object.keys(emotionBlend)
          .map((e) => `${e} (${Math.round(emotionBlend[e] * 100)}%)`)
          .join(", ");

        let intensityText =
          currentIntensity >= 2.0
            ? "EXTREME"
            : currentIntensity >= 1.5
            ? "HIGH"
            : currentIntensity >= 1.0
            ? "MODERATE"
            : "MILD";

        document.getElementById("room-status").innerText = emotionText;
        document.getElementById(
          "intensity-display"
        ).innerText = `Intensity: ${intensityText}`;

        // Reset overlays
        document
          .querySelectorAll(
            ".rain-overlay, .fog-overlay, .sunset-glow, .heat-wave, .love-glow, .dark-overlay"
          )
          .forEach((el) => el.classList.remove("active"));

        Object.values(particles).forEach((p) => (p.material.opacity = 0));

        // Apply emotion effects
        emotionState = {
          targetHeight: 3.5,
          currentHeight: emotionState.currentHeight,
          breathing: 0.05,
          shake: 0,
        };

        for (let emotion in emotionBlend) {
          const weight = emotionBlend[emotion] * currentIntensity;
          applyEmotionEffect(emotion, weight);
        }
      }

      // APPLY EMOTION EFFECTS
      function applyEmotionEffect(emotion, weight) {
        switch (emotion) {
          case "HAPPY":
            emotionState.targetHeight += (5.5 - 3.5) * weight;
            document.getElementById("sunset-glow").classList.add("active");
            particles.sparkle.material.opacity += 0.4 * weight;
            particles.sparkle.material.color.setHex(0xffee66);
            break;

          case "LOVE":
            emotionState.targetHeight += (4.5 - 3.5) * weight;
            document.getElementById("love-glow").classList.add("active");
            particles.sparkle.material.opacity += 0.6 * weight;
            particles.sparkle.material.color.setHex(0xffaaff);
            break;

          case "PEACE":
            emotionState.targetHeight += (4.0 - 3.5) * weight;
            emotionState.breathing = 0.02;
            particles.dust.material.opacity += 0.3 * weight;
            break;

          case "HOPE":
            emotionState.targetHeight += (4.5 - 3.5) * weight;
            document.getElementById("sunset-glow").classList.add("active");
            particles.dust.material.opacity += 0.4 * weight;
            particles.dust.material.color.setHex(0xffffcc);
            break;

          case "ANXIETY":
            emotionState.targetHeight += (2.5 - 3.5) * weight;
            emotionState.breathing += 0.2 * weight;
            emotionState.shake += 0.15 * weight;
            break;

          case "FEAR":
            emotionState.targetHeight += (2.8 - 3.5) * weight;
            emotionState.breathing += 0.15 * weight;
            document.getElementById("dark-overlay").classList.add("active");
            break;

          case "ANGER":
            emotionState.targetHeight += (2.0 - 3.5) * weight;
            emotionState.breathing += 0.25 * weight;
            emotionState.shake += 0.25 * weight;
            document.getElementById("heat-wave").classList.add("active");
            break;

          case "SADNESS":
          case "GRIEF":
            emotionState.targetHeight += (2.8 - 3.5) * weight;
            emotionState.breathing = Math.max(
              0.06,
              emotionState.breathing * (1 - 0.3 * weight)
            );
            document.getElementById("rain-overlay").classList.add("active");
            particles.rain.material.opacity += 0.6 * weight;
            break;

          case "LONELINESS":
            emotionState.targetHeight += (5.0 - 3.5) * weight;
            emotionState.breathing = 0.02;
            scene.fog.near = 8 - 3 * weight;
            scene.fog.far = 20 - 5 * weight;
            break;

          case "NOSTALGIA":
            emotionState.targetHeight += (3.2 - 3.5) * weight;
            emotionState.breathing = 0.04;
            particles.dust.material.opacity += 0.5 * weight;
            particles.dust.material.color.setHex(0xd4c4a4);
            break;

          case "CONTEMPLATION":
            emotionState.targetHeight += (4.0 - 3.5) * weight;
            emotionState.breathing = 0.025;
            particles.dust.material.opacity += 0.4 * weight;
            document.getElementById("fog-overlay").classList.add("active");
            particles.mist.material.opacity += 0.3 * weight;
            break;
        }
      }

      // ANIMATION LOOP
      function animate() {
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();
        const delta = clock.getDelta();

        if (hasEntered && !isTransitioning) {
          // Smooth ceiling height transition
          emotionState.currentHeight = THREE.MathUtils.lerp(
            emotionState.currentHeight,
            emotionState.targetHeight,
            0.02
          );

          // Breathing effect on current room's ceiling
          if (roomObjects[currentRoom]) {
            roomObjects[currentRoom].children.forEach((child) => {
              if (
                child.geometry &&
                child.geometry.type === "PlaneGeometry" &&
                child.rotation.x > 3
              ) {
                child.position.y =
                  emotionState.currentHeight +
                  Math.sin(time * 0.5) * emotionState.breathing;
              }
            });
          }

          // Camera shake
          if (emotionState.shake > 0.01) {
            const roomCam = ROOMS[currentRoom].camera;
            camera.position.x =
              roomCam.x + Math.sin(time * 50) * emotionState.shake;
            camera.position.y =
              roomCam.y + Math.cos(time * 40) * emotionState.shake;
            camera.rotation.z = Math.sin(time * 30) * emotionState.shake * 0.01;
          } else {
            const roomCam = ROOMS[currentRoom].camera;
            camera.position.x = THREE.MathUtils.lerp(
              camera.position.x,
              roomCam.x,
              0.1
            );
            camera.position.y = THREE.MathUtils.lerp(
              camera.position.y,
              roomCam.y,
              0.1
            );
            camera.rotation.z = THREE.MathUtils.lerp(camera.rotation.z, 0, 0.1);
          }

          // Animate particles
          if (particles.rain.material.opacity > 0) {
            const pos = particles.rain.geometry.attributes.position.array;
            for (let i = 1; i < pos.length; i += 3) {
              pos[i] -= 0.15;
              if (pos[i] < 0) pos[i] = 10;
            }
            particles.rain.geometry.attributes.position.needsUpdate = true;
          }

          if (particles.mist.material.opacity > 0) {
            const pos = particles.mist.geometry.attributes.position.array;
            for (let i = 0; i < pos.length; i += 3) {
              pos[i + 1] += 0.008;
              pos[i] += Math.sin(time + i) * 0.002;
              if (pos[i + 1] > 4) pos[i + 1] = 0;
            }
            particles.mist.geometry.attributes.position.needsUpdate = true;
          }

          if (particles.sparkle.material.opacity > 0) {
            const pos = particles.sparkle.geometry.attributes.position.array;
            for (let i = 0; i < pos.length; i += 3) {
              pos[i + 1] += Math.sin(time * 2 + i) * 0.01;
              pos[i] += Math.cos(time * 1.5 + i) * 0.01;
              pos[i + 2] += Math.sin(time * 1.8 + i) * 0.01;
            }
            particles.sparkle.geometry.attributes.position.needsUpdate = true;
            particles.sparkle.material.size = 0.12 + Math.sin(time * 3) * 0.05;
          }

          if (particles.dust.material.opacity > 0) {
            const pos = particles.dust.geometry.attributes.position.array;
            for (let i = 0; i < pos.length; i += 3) {
              pos[i + 1] += 0.003;
              pos[i] += Math.sin(time * 0.5 + i) * 0.003;
              if (pos[i + 1] > 3.5) pos[i + 1] = 0.2;
            }
            particles.dust.geometry.attributes.position.needsUpdate = true;
          }
        }

        renderer.render(scene, camera);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      window.addEventListener("DOMContentLoaded", init3D);
    </script>
  </body>
</html>
